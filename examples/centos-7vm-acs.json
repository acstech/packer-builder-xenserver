{
  "builders": [
    {
      "type": "xenserver-vm",
      "remote_host": "10.204.136.32",
      "remote_username": "root",
      "remote_password": "{{user `xenserver_password`}}",

      "boot_command": [
        "<enter>root<enter><wait5>Password1<enter><wait>",
	 "cp /etc/sysconfig/network-scripts/ifcfg-eth0 ./ifcfg-eth0.bak<enter>",
	 "sudo vi ./ifcfg-eth0.tmp<enter><wait>",
	 "i<enter># Generated by XenServer packer plugin<enter>",
	 "DEVICE=\"eth0\"<enter>",
	 "ONBOOT=yes<enter>",
	 "NETBOOT=yes<enter>",
	 "BOOTPROTO=dhcp<enter>",
	 "TYPE=Ethernet<enter>",
	 "NAME=\"eth0\"<enter>",
	 "NM_CONTROLLED=no<enter>",
	 "<esc>:wq!<enter><wait>",
	 "sudo cp ./ifcfg-eth0.tmp /etc/sysconfig/network-scripts/ifcfg-eth0<enter>",
	 "sudo ifdown eth0<enter><wait5>",
	 "sudo ifup eth0<enter><wait5>",
	 "curl http://169.254.0.1/packer-clean.sh > ./packer-clean.sh <enter><wait10>",
	 "sudo chmod +x packer-clean.sh<enter>",
	 "sudo ./packer-clean.sh<enter>"
      ],
      "boot_wait": "45s",
      "http_directory": "/var/www/html/packer",
      "source_vm": "CentOS7",

      "script_url": "http://10.204.137.80/packer/xenserver/",
      "output_directory": "/var/www/html/vhd",
      "format": "vhd",
      "shutdown_command": "",
      "ssh_username": "root",
      "ssh_password": "Password1",
      "ssh_wait_timeout": "10000s",
      "sr_name": "NFS Packer",
      "vm_name": "packer-export-centos7",
      "nfs_mount": "10.204.136.41:/vol/exports/packer"
    }
  ],

  "variables": {
    "xenserver_password": "{{env `XS_PASS`}}"
  },

  "provisioners": [
	{
	  "type": "file",
	  "source": "/var/www/html/packer/acs/cloud-set-guest-password.service",
	  "destination": "/etc/systemd/system/cloud-set-client-password.service"
	},
	{
	  "type": "file",
	  "source": "/var/www/html/packer/acs/cloud-set-guest-password.sh",
	  "destination": "/usr/local/bin/cloud-set-guest-password.sh"
	},
	{
	  "type": "file",
	  "source": "/var/www/html/packer/acs/centos7-reset.sh",
	  "destination": "/tmp/centos7-reset.sh"
	},
	{
	  "type": "shell",
	  "inline": ["chmod +x /usr/local/bin/cloud-set-guest-password.sh"]
	},
	{
	  "type": "shell",
	  "inline": ["systemctl enable /etc/systemd/system/cloud-set-client-password.service"]
	},
	{
	  "type": "shell",
	  "inline": ["chmod +x /tmp/centos7-reset.sh"]
	},
	{
	  "type": "shell",
	  "inline": ["/tmp/centos7-reset.sh"]
	}
  ],


  "post-processors": [
    {
      	"type": "cloudstack-xenserver",
	"apiurl": "http://10.204.146.18:8080/client/api",
	"apikey": "QNgS1favp6l2XfAwanPMSHJBMqZqHtpz1ncSEt3HglPQtAC8H37ScvPoGmtKx2NILCvIf-TK_FobmTMWHsKF3w",
	"secret": "zkXCTLihWzUEFsYgldeavldZvUZF0WO5J1l54JSVNK7qk5eb-G_0OtVL28YIw0sq9_NYvTj8RzEwElNy0j6bgQ",
	"display_text": "A CentOS7 template with tools",
	"template_name": "Packer CentOS7",
	"os_type": "Other CentOS (64-bit)",
	"download_url": "http://10.204.137.80/vhd/",
	"compress_vhd": "false",
	"zone": "Boston Test",
	"account": "",
	"domain": "",
	"password_enabled": "true",
	"ssh_enabled": "true",
	"has_tools": "true",
	"keep_input_artifact": true
    }
  ]
}
